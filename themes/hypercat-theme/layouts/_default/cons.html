{{- define "main" }}
<article class="post-single">
    <header class="post-header">
        <h1 class="post-title">{{ .Title }}</h1>
    </header>

    <div class="cons-container">
        {{- $now := now }}
        {{- $nowYear := $now.Format "2006" | int }}
        {{- $upcoming := slice }}
        {{- $past := slice }}

        {{- range .Site.RegularPages }}
        {{- if eq .Type "cons" }}
        {{- /* Check if convention has any future years or staff positions */}}
        {{- $hasFuture := false }}
        {{- $hasPast := false }}
        {{- $con := . }}

        {{- /* Check attendee years */}}
        {{- if $con.Params.attendeeYears }}
          {{- range split $con.Params.attendeeYears ", " }}
            {{- $yearStr := trim . " " }}
            {{- $year := 0 }}
            {{- if and $yearStr (in "0123456789" (substr $yearStr 0 1)) }}
              {{- $year = $yearStr | int }}
              {{- if gt $year $nowYear }}
                {{- $hasFuture = true }}
              {{- else if eq $year $nowYear }}
                {{- /* For current year, check if month is upcoming */}}
                {{- $conMonth := $con.Params.month }}
                {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                {{- $nowMonth := $now.Format "01" | int }}
                {{- if ge $monthNum $nowMonth }}
                  {{- $hasFuture = true }}
                {{- else }}
                  {{- $hasPast = true }}
                {{- end }}
              {{- else }}
                {{- $hasPast = true }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}

        {{- /* Check staff years */}}
        {{- if $con.Params.staffYears }}
          {{- range split $con.Params.staffYears ", " }}
            {{- $yearStr := trim . " " }}
            {{- $year := 0 }}
            {{- if and $yearStr (in "0123456789" (substr $yearStr 0 1)) }}
              {{- $year = $yearStr | int }}
              {{- if gt $year $nowYear }}
                {{- $hasFuture = true }}
              {{- else if eq $year $nowYear }}
                {{- /* For current year, check if month is upcoming */}}
                {{- $conMonth := $con.Params.month }}
                {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                {{- $nowMonth := $now.Format "01" | int }}
                {{- if ge $monthNum $nowMonth }}
                  {{- $hasFuture = true }}
                {{- else }}
                  {{- $hasPast = true }}
                {{- end }}
              {{- else }}
                {{- $hasPast = true }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}

        {{- /* Add to appropriate sections */}}
        {{- if $hasFuture }}
          {{- $upcoming = $upcoming | append $con }}
        {{- end }}
        {{- if $hasPast }}
          {{- $past = $past | append $con }}
        {{- end }}
        {{- end }}
        {{- end }}

        {{- /* Sort conventions by month */}}
        {{- /* Create a list with month values for sorting */}}
        {{- $upcomingWithMonth := slice }}
        {{- range $upcoming }}
        {{- $monthStr := partial "get-con-month.html" (dict "con" . "now" $now) }}
        {{- $upcomingWithMonth = $upcomingWithMonth | append (dict "page" . "month" $monthStr) }}
        {{- end }}

        {{- /* Sort by month string */}}
        {{- $upcoming = slice }}
        {{- range (sort $upcomingWithMonth "month") }}
        {{- $upcoming = $upcoming | append .page }}
        {{- end }}

        {{- $pastWithMonth := slice }}
        {{- range $past }}
        {{- /* For past conventions, sort by month only */}}
        {{- $month := .Params.month }}
        {{- $monthNum := partial "month-name-to-num.html" $month }}
        {{- $pastWithMonth = $pastWithMonth | append (dict "page" . "monthNum" ($monthNum | int)) }}
        {{- end }}

        {{- /* Sort past conventions in ascending order by month */}}
        {{- $past = slice }}
        {{- range (sort $pastWithMonth "monthNum") }}
        {{- $past = $past | append .page }}
        {{- end }}

        {{- if $upcoming }}
        <section class="upcoming-cons-section">
            <h2>Upcoming Conventions</h2>
            {{- range $index, $con := $upcoming }}
            <div class="con-entry">
                <div class="con-main-content">
                    <h2 class="con-title">{{ $con.Title }}</h2>
                    <p class="con-dates">
                        {{- $nowYear := $now.Format "2006" | int }}
                        {{- $conYear := partial "extract-year.html" (dict "con" $con "now" $now) }}
                        {{- if $con.Params.staffYears }}
                        {{- /* Filter staff years to only future years */}}
                        {{- $futureStaffYears := slice }}
                        {{- $conMonth := $con.Params.month }}
                        {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                        {{- $nowMonth := $now.Format "01" | int }}
                        {{- range split $con.Params.staffYears ", " }}
                        {{- $year := strings.TrimSpace . }}
                        {{- $yearInt := 0 }}
                        {{- if and $year (in "0123456789" (substr $year 0 1)) }}
                        {{- $yearInt = $year | int }}
                        {{- if or (gt $yearInt $nowYear) (and (eq $yearInt $nowYear) (ge $monthNum $nowMonth)) }}
                        {{- $futureStaffYears = $futureStaffYears | append $year }}
                        {{- end }}
                        {{- end }}
                        {{- end }}
                        {{- if gt (len $futureStaffYears) 0 }}
                        <span class="staff-badge">Staff: {{ delimit $futureStaffYears ", " }}</span>
                        {{- end }}
                        {{- else if $con.Params.attendeeYears }}
                        {{- /* Filter attendee years to only future years */}}
                        {{- $futureAttendeeYears := slice }}
                        {{- $conMonth := $con.Params.month }}
                        {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                        {{- $nowMonth := $now.Format "01" | int }}
                        {{- range split $con.Params.attendeeYears ", " }}
                        {{- $year := strings.TrimSpace . }}
                        {{- $yearInt := 0 }}
                        {{- if and $year (in "0123456789" (substr $year 0 1)) }}
                        {{- $yearInt = $year | int }}
                        {{- if or (gt $yearInt $nowYear) (and (eq $yearInt $nowYear) (ge $monthNum $nowMonth)) }}
                        {{- $futureAttendeeYears = $futureAttendeeYears | append $year }}
                        {{- end }}
                        {{- end }}
                        {{- end }}
                        {{- if gt (len $futureAttendeeYears) 0 }}
                        {{- delimit $futureAttendeeYears ", " }}
                        {{- end }}
                        {{- else }}
                        {{ $conYear }}
                        {{- end }}
                    </p>
                </div>
                <div class="con-location">
                    {{- if $con.Params.location }}
                    {{ $con.Params.location }}
                    {{- else }}
                    TBA
                    {{- end }}
                </div>
            </div>
            {{- if ne $index (sub (len $upcoming) 1) }}
            <hr class="con-separator">
            {{- end }}
            {{- end }}
        </section>
        {{- end }}

        {{- /* Check if we have past conventions or upcoming with years */}}
        {{- $hasPast := false }}
        {{- if $past }}{{ $hasPast = true }}{{- end }}
        {{- range $upcoming }}{{ if .Params.attendeeYears }}{{ $hasPast = true }}{{- end }}{{- end }}

        {{- if $hasPast }}
        <section class="past-cons-section">
            <h2>Past Conventions</h2>
            {{- range $index, $con := $past }}
            <div class="con-entry past">
                <div class="con-main-content">
                    {{- $normalizedName := partial "normalize-con-name.html" $con.Title }}
                    <h2 class="con-title"><a href="https://photo.felle.me/Furries/Cons/{{ $normalizedName }}" title="View all photos (opens in new tab)" target="_blank" rel="noopener noreferrer">{{ $con.Title }}</a></h2>
                    <p class="con-dates">
                        {{- $nowYear := $now.Format "2006" | int }}
                        {{- $conYear := partial "extract-year.html" (dict "con" $con "now" $now) }}
                        {{- $pastYears := slice }}
                        {{- $pastStaff := slice }}

                        {{- /* Collect past attendee years */}}
                        {{- if $con.Params.attendeeYears }}
                        {{- $conMonth := $con.Params.month }}
                        {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                        {{- $nowMonth := $now.Format "01" | int }}
                        {{- range split $con.Params.attendeeYears ", " }}
                        {{- $year := strings.TrimSpace . }}
                        {{- $yearInt := 0 }}
                        {{- if and $year (in "0123456789" (substr $year 0 1)) }}
                        {{- $yearInt = $year | int }}
                        {{- if or (lt $yearInt $nowYear) (and (eq $yearInt $nowYear) (lt $monthNum $nowMonth)) }}
                        {{- $pastYears = $pastYears | append $year }}
                        {{- end }}
                        {{- end }}
                        {{- end }}
                        {{- end }}

                        {{- /* Collect past staff years */}}
                        {{- if $con.Params.staffYears }}
                        {{- $conMonth := $con.Params.month }}
                        {{- $monthNum := partial "month-name-to-num.html" $conMonth }}
                        {{- $nowMonth := $now.Format "01" | int }}
                        {{- range split $con.Params.staffYears ", " }}
                        {{- $year := strings.TrimSpace . }}
                        {{- $yearInt := 0 }}
                        {{- if and $year (in "0123456789" (substr $year 0 1)) }}
                        {{- $yearInt = $year | int }}
                        {{- if or (lt $yearInt $nowYear) (and (eq $yearInt $nowYear) (lt $monthNum $nowMonth)) }}
                        {{- $pastStaff = $pastStaff | append $year }}
                        {{- end }}
                        {{- end }}
                        {{- end }}
                        {{- end }}

                        {{- /* Display past attendee years with links */}}
                        {{- if gt (len $pastYears) 0 }}
                        {{- range $i, $year := $pastYears }}{{- if $i }}, {{ end }}<a href="https://photo.felle.me/Furries/Cons/{{ $normalizedName }}/{{ $year }}" title="View photos (opens in new tab)" target="_blank" rel="noopener noreferrer">{{ $year }}</a>{{- end }}
                        {{- end }}

                        {{- /* Display past staff years with links */}}
                        {{- if gt (len $pastStaff) 0 }}
                        {{- if gt (len $pastYears) 0 }} â€¢ {{ end }}<span class="staff-badge">Staff: {{- range $i, $year := $pastStaff }}{{- if $i }}, {{ end }}<a href="https://photo.felle.me/Furries/Cons/{{ $normalizedName }}/{{ $year }}" title="View photos (opens in new tab)" class="staff-badge-link" target="_blank" rel="noopener noreferrer">{{ $year }}</a>{{- end }}</span>
                        {{- end }}

                        {{- /* Fallback if no years found */}}
                        {{- if and (eq (len $pastYears) 0) (eq (len $pastStaff) 0) }}
                        {{- if $con.Params.pastYears }}
                        {{- range $i, $year := split $con.Params.pastYears ", " }}{{- if $i }}, {{ end }}<a href="https://photo.felle.me/Furries/Cons/{{ $normalizedName }}/{{ trim $year " " }}" title="View photos (opens in new tab)" target="_blank" rel="noopener noreferrer">{{ trim $year " " }}</a>{{- end }}
                        {{- else }}
                        <a href="https://photo.felle.me/Furries/Cons/{{ $normalizedName }}/{{ $conYear }}" title="View photos (opens in new tab)" target="_blank" rel="noopener noreferrer">{{ $conYear }}</a>
                        {{- end }}
                        {{- end }}
                    </p>
                </div>
                <div class="con-location">
                    {{- if $con.Params.location }}
                    {{ $con.Params.location }}
                    {{- else }}
                    TBA
                    {{- end }}
                </div>
            </div>
            {{- if ne $index (sub (len $past) 1) }}
            <hr class="con-separator">
            {{- end }}
            {{- end }}
        </section>
        {{- end }}
    </div>
</article>
{{- end }}
