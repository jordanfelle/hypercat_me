{{- define "main" }}
<article class="post-single">
    <header class="post-header">
        <h1 class="post-title">{{ .Title }}</h1>
    </header>

    <div class="cons-container">
        {{- $now := now }}
        {{- $nowMonth := $now.Format "2006-01" }}
        {{- $upcoming := slice }}
        {{- $past := slice }}

        {{- range .Site.RegularPages }}
        {{- if eq .Type "cons" }}
        {{- /* Convert month name to comparable YYYY-MM format, using latest year from attendeeYears/staffYears */}}
        {{- $compareMonth := partial "get-con-month.html" (dict "con" . "now" $now) }}
        {{- /* Categorize as upcoming or past based on month.
        Conventions are assumed to happen on the last day of the month.
        If in the current month, check if today is before the end of month. */}}
        {{- $isUpcoming := false }}
        {{- if gt $compareMonth $nowMonth }}
        {{- $isUpcoming = true }}
        {{- else if eq $compareMonth $nowMonth }}
        {{- /* Same month - check if we're before the last day */}}
        {{- $lastDayOfMonth := ($now.AddDate 0 1 0).AddDate 0 0 -1 }}
        {{- if lt $now.Day $lastDayOfMonth.Day }}
        {{- $isUpcoming = true }}
        {{- end }}
        {{- end }}
        {{- if $isUpcoming }}
        {{- $upcoming = $upcoming | append . }}
        {{- else }}
        {{- $past = $past | append . }}
        {{- end }}
        {{- end }}
        {{- end }}

        {{- /* Sort conventions by month */}}
        {{- /* Create a list with month values for sorting */}}
        {{- $upcomingWithMonth := slice }}
        {{- range $upcoming }}
        {{- $monthStr := partial "get-con-month.html" (dict "con" . "now" $now) }}
        {{- $upcomingWithMonth = $upcomingWithMonth | append (dict "page" . "month" $monthStr) }}
        {{- end }}

        {{- /* Sort by month string */}}
        {{- $upcoming = slice }}
        {{- range (sort $upcomingWithMonth "month") }}
        {{- $upcoming = $upcoming | append .page }}
        {{- end }}

        {{- $pastWithMonth := slice }}
        {{- range $past }}
        {{- $monthStr := partial "get-con-month.html" (dict "con" . "now" $now) }}
        {{- $pastWithMonth = $pastWithMonth | append (dict "page" . "month" $monthStr) }}
        {{- end }}

        {{- /* Sort past conventions in descending order */}}
        {{- $past = slice }}
        {{- range (sort $pastWithMonth "month" "desc") }}
        {{- $past = $past | append .page }}
        {{- end }}

        {{- if $upcoming }}
        <section class="upcoming-cons-section">
            <h2>Upcoming Conventions</h2>
            {{- range $index, $con := $upcoming }}
            <div class="con-entry">
                <div class="con-main-content">
                    <h2 class="con-title"><a href="{{ $con.RelPermalink }}">{{ $con.Title }}</a></h2>
                    <p class="con-dates">
                        {{- if $con.Params.staffYears }}
                        {{- /* Extract convention year */}}
                        {{- $monthStr := $con.Params.month }}
                        {{- $conYear := partial "extract-year.html" (dict "monthStr" $monthStr "now" $now) }}
                        {{- /* Filter staff years to only future years */}}
                        {{- $futureStaffYears := slice }}
                        {{- range split $con.Params.staffYears ", " }}
                        {{- $year := strings.TrimSpace . }}
                        {{- $yearInt := 0 }}
                        {{- if (in "0123456789" (substr $year 0 1)) }}
                        {{- $yearInt = $year | int }}
                        {{- if ge $yearInt $conYear }}
                        {{- $futureStaffYears = $futureStaffYears | append $year }}
                        {{- end }}
                        {{- end }}
                        {{- end }}
                        {{- if gt (len $futureStaffYears) 0 }}
                        <span class="staff-badge">Staff: {{ delimit $futureStaffYears ", " }}</span>
                        {{- end }}
                        {{- else }}
                        {{- partial "extract-year.html" (dict "monthStr" $con.Params.month "now" $now) }}
                        {{- end }}
                    </p>
                </div>
                <div class="con-location">
                    {{- if $con.Params.location }}
                    {{ $con.Params.location }}
                    {{- else }}
                    TBA
                    {{- end }}
                </div>
            </div>
            {{- if ne $index (sub (len $upcoming) 1) }}
            <hr class="con-separator">
            {{- end }}
            {{- end }}
        </section>
        {{- end }}

        {{- /* Check if we have past conventions or upcoming with years */}}
        {{- $hasPast := false }}
        {{- if $past }}{{ $hasPast = true }}{{- end }}
        {{- range $upcoming }}{{ if .Params.attendeeYears }}{{ $hasPast = true }}{{- end }}{{- end }}

        {{- if $hasPast }}
        <section class="past-cons-section">
            <h2>Past Conventions</h2>
            {{- range $index, $con := $past }}
            <div class="con-entry past">
                <div class="con-main-content">
                    <h2 class="con-title"><a href="{{ $con.RelPermalink }}">{{ $con.Title }}</a></h2>
                    <p class="con-dates">
                        {{- if $con.Params.pastYears }}
                        {{ $con.Params.pastYears }}
                        {{- else if $con.Params.attendeeYears }}
                        {{- delimit (split $con.Params.attendeeYears ", ") ", " }}
                        {{- else }}
                        {{ $con.Date.Format "Jan 2006" }}
                        {{- end }}
                    </p>
                </div>
                <div class="con-location">
                    {{- if $con.Params.location }}
                    {{ $con.Params.location }}
                    {{- else }}
                    TBA
                    {{- end }}
                </div>
            </div>
            {{- if or (ne $index (sub (len $past) 1)) ($upcoming) }}
            <hr class="con-separator">
            {{- end }}
            {{- end }}

            {{- /* Show upcoming conventions with years in past section too */}}
            {{- range $upcomingIndex, $con := $upcoming }}
            {{- if or $con.Params.attendeeYears $con.Params.staffYears }}
            {{- $allYears := slice }}
            {{- if $con.Params.attendeeYears }}
            {{- $allYears = split $con.Params.attendeeYears ", " }}
            {{- end }}
            {{- if $con.Params.staffYears }}
            {{- $staffYears := split $con.Params.staffYears ", " }}
            {{- range $staffYears }}
            {{- $allYears = $allYears | append . }}
            {{- end }}
            {{- end }}
            {{- $monthStr := $con.Params.month }}
            {{- if not $monthStr }}
            {{- $monthStr = ($con.Date.Format "2006-01") }}
            {{- end }}
            {{- /* Extract year from month string */}}
            {{- $conYear := partial "extract-year.html" (dict "monthStr" $monthStr "now" $now) }}
            {{- $pastYearsArr := slice }}
            {{- $pastStaffArr := slice }}
            {{- range $allYears }}
            {{- $year := strings.TrimSpace . }}
            {{- $yearInt := 0 }}
            {{- if (in "0123456789" (substr $year 0 1)) }}
            {{- $yearInt = $year | int }}
            {{- if lt $yearInt $conYear }}
            {{- /* Check if this year is a staff year */}}
            {{- $isStaff := false }}
            {{- if $con.Params.staffYears }}
            {{- range split $con.Params.staffYears ", " }}
            {{- if eq (strings.TrimSpace .) $year }}
            {{- $isStaff = true }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- if $isStaff }}
            {{- $pastStaffArr = $pastStaffArr | append $year }}
            {{- else }}
            {{- $pastYearsArr = $pastYearsArr | append $year }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- if or (gt (len $pastYearsArr) 0) (gt (len $pastStaffArr) 0) }}
            <div class="con-entry past">
                <div class="con-main-content">
                    <h2 class="con-title"><a href="{{ $con.RelPermalink }}">{{ $con.Title }}</a></h2>
                    <p class="con-dates">
                        {{- if gt (len $pastYearsArr) 0 }}
                        {{- delimit $pastYearsArr ", " }}
                        {{- end }}
                        {{- if and (gt (len $pastYearsArr) 0) (gt (len $pastStaffArr) 0) }}
                        â€¢
                        {{- end }}
                        {{- if gt (len $pastStaffArr) 0 }}
                        <span class="staff-badge">Staff: {{ delimit $pastStaffArr ", " }}</span>
                        {{- end }}
                    </p>
                </div>
                <div class="con-location">
                    {{- if $con.Params.location }}
                    {{ $con.Params.location }}
                    {{- else }}
                    TBA
                    {{- end }}
                </div>
            </div>
            {{- if ne $upcomingIndex (sub (len $upcoming) 1) }}
            <hr class="con-separator">
            {{- end }}
            {{- end }}
            {{- end }}
            {{- end }}
        </section>
        {{- end }}
    </div>
</article>
{{- end }}
