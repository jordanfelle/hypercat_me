{{- define "main" }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/css/glightbox.min.css">
<style>
    .poses-image-link {
        position: relative;
        display: inline-block;
    }
    .poses-image-number {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        pointer-events: none;
        z-index: 10;
    }
    /* Lightbox badge styling */
    .gslide-media {
        position: relative !important;
    }
    .glightbox-container .gslide-description,
    .gslide-description {
        position: absolute !important;
        bottom: 20px !important;
        right: 20px !important;
        left: auto !important;
        top: auto !important;
        background: rgba(0, 0, 0, 0.75) !important;
        color: white !important;
        padding: 6px 12px !important;
        border-radius: 4px !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        z-index: 1000 !important;
        width: auto !important;
        max-width: none !important;
        margin: 0 !important;
        transform: none !important;
    }
    .glightbox-container .gslide-title {
        display: none !important;
    }
    .gslide-description p {
        margin: 0 !important;
    }
    /* Navigation links */
    .poses-navigation {
        margin: 2rem 0;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        text-align: center;
    }
    .poses-nav-links {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 0;
        padding: 0;
        list-style: none;
    }
    .poses-nav-link {
        padding: 0.5rem 1.5rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        text-decoration: none;
        color: inherit;
        font-weight: 500;
        transition: background 0.2s;
    }
    .poses-nav-link:hover {
        background: rgba(0, 0, 0, 0.2);
    }
    /* Collapsible sections */
    .poses-section {
        margin-bottom: 2rem;
    }
    .poses-section-title {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }
    .poses-section-title:hover {
        opacity: 0.8;
    }
    .poses-collapse-icon {
        display: inline-block;
        transition: transform 0.3s;
        font-size: 0.8em;
    }
    .poses-section.collapsed .poses-collapse-icon {
        transform: rotate(-90deg);
    }
    .poses-section-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        max-height: 10000px;
        opacity: 1;
    }
    .poses-section.collapsed .poses-section-content {
        max-height: 0;
        opacity: 0;
    }
</style>

<header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
</header>

<nav class="poses-navigation">
    <ul class="poses-nav-links">
        <li><a href="#solo" class="poses-nav-link">Solo</a></li>
        <li><a href="#duo" class="poses-nav-link">Duo</a></li>
        <li><a href="#triple" class="poses-nav-link">Triple</a></li>
        <li><a href="#groups" class="poses-nav-link">Groups</a></li>
    </ul>
</nav>

<div class="poses-container">
        {{- $poseCategories := slice "solo" "duo" "triple" "groups" }}
        
        {{- range $poseCategories }}
        {{- $category := . }}
        {{- $section := $.Site.GetPage (printf "/poses/%s" $category) }}
        {{- $categoryTitle := "Gallery" }}
        {{- if $section }}
            {{- $categoryTitle = $section.Title }}
        {{- end }}
        
        {{- /* Get images from the section's resources */ -}}
        {{- $images := slice }}
        {{- $imageMap := dict }}
        {{- if $section }}
            {{- range $section.Resources.Match "*.{jpg,jpeg,png,webp,gif}" }}
                {{- $numericName := int (path.BaseName .Name) }}
                {{- $imageMap = merge $imageMap (dict (string $numericName) .) }}
            {{- end }}
            {{- /* Sort by numeric key and rebuild slice */ -}}
            {{- $sortedKeys := slice }}
            {{- range $key, $val := $imageMap }}
                {{- $sortedKeys = $sortedKeys | append (int $key) }}
            {{- end }}
            {{- $sortedKeys = sort $sortedKeys }}
            {{- range $sortedKeys }}
                {{- $images = $images | append (index $imageMap (string .)) }}
            {{- end }}
        {{- end }}
        
        <section class="poses-section" id="{{ $category }}">
            <h2 class="poses-section-title">
                <span class="poses-collapse-icon">â–¼</span>
                {{ $categoryTitle }}
            </h2>
            <div class="poses-section-content">
            {{- if gt (len $images) 0 }}
                <div class="poses-grid">
                    {{- range $images }}
                    {{- $small := .Fit "300x2000 q85" }}
                    {{- $medium := .Fit "600x2000 q85" }}
                    {{- $large := .Fit "1200x2000 q85" }}
                    {{- $imageName := path.BaseName .Name }}
                    <a href="{{ $large.RelPermalink }}" class="poses-image-link" data-lg-size="{{ $large.Width }}-{{ $large.Height }}" data-description="{{ $imageName }}">
                        <img 
                            src="{{ $small.RelPermalink }}" 
                            srcset="{{ $small.RelPermalink }} 300w, {{ $medium.RelPermalink }} 600w, {{ $large.RelPermalink }} 1200w"
                            sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                            alt="{{ $imageName }}"
                            class="poses-grid-image"
                            loading="lazy"
                        >
                        <span class="poses-image-number">{{ $imageName }}</span>
                    </a>
                    {{- end }}
                </div>
            {{- else }}
                <p class="poses-empty-gallery">No images yet. Add images to <code>content/poses/{{ $category }}/</code></p>
            {{- end }}
            </div>
        </section>
        {{- end }}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/js/glightbox.min.js"></script>
<script>
    (function() {
        'use strict';
        
        function initGallery() {
            // Initialize justified gallery
            if (window.jQuery && jQuery.fn.justifiedGallery) {
                jQuery('.poses-grid').justifiedGallery({
                    rowHeight: 220,
                    margins: 16,
                    lastRow: 'nojustify',
                    captions: false,
                    imagesSelector: 'img'
                });
            }
            
            // Initialize GLightbox
            if (!window.GLightbox) return;
            
            var lightbox = GLightbox({ 
                selector: '.poses-grid a',
                touchNavigation: true,
                loop: true,
                slideEffect: 'slide'
            });
            
            // Style description as badge on image
            function styleDescription() {
                var desc = document.querySelector('.gslide-description');
                var media = document.querySelector('.gslide-media');
                if (desc && media && desc.parentElement !== media) {
                    media.appendChild(desc);
                }
            }
            
            lightbox.on('open', function() { setTimeout(styleDescription, 100); });
            lightbox.on('slide_changed', function() { setTimeout(styleDescription, 100); });
        }
        
        // Add collapsible section functionality
        function initCollapsible() {
            var titles = document.querySelectorAll('.poses-section-title');
            titles.forEach(function(title) {
                title.addEventListener('click', function() {
                    var section = this.closest('.poses-section');
                    section.classList.toggle('collapsed');
                });
            });
        }
        
        // Smooth scroll for navigation links
        function initNavigation() {
            var navLinks = document.querySelectorAll('.poses-nav-link');
            navLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var targetId = this.getAttribute('href').substring(1);
                    var targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        // Expand section if collapsed
                        targetSection.classList.remove('collapsed');
                        // Smooth scroll to section
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initGallery();
                initCollapsible();
                initNavigation();
            });
        } else {
            initGallery();
            initCollapsible();
            initNavigation();
        }
    })();
</script>
{{- end }}
