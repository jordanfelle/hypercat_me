{{- define "main" }}
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css" as="style" integrity="sha384-V/1Ew9pYm8xpy/L9i078ZXT6HSEOrGC6KNFYLbXOdtqb3+c6brpGqVzZtEPSQOiz" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css" integrity="sha384-V/1Ew9pYm8xpy/L9i078ZXT6HSEOrGC6KNFYLbXOdtqb3+c6brpGqVzZtEPSQOiz" crossorigin="anonymous"></noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.1/css/glightbox.min.css" as="style" integrity="sha384-GPAzSuZc0kFvdIev6wm9zg8gnafE8tLso7rsAYQfc9hAdWCpOcpcNI5W9lWkYcsd" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.1/css/glightbox.min.css" integrity="sha384-GPAzSuZc0kFvdIev6wm9zg8gnafE8tLso7rsAYQfc9hAdWCpOcpcNI5W9lWkYcsd" crossorigin="anonymous"></noscript>
<style>
    .poses-image-link {
        position: relative;
        display: inline-block;
    }
    .poses-image-number {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        pointer-events: none;
        z-index: 10;
    }
    /* Lightbox badge styling */
    .gslide-media {
        position: relative !important;
    }
    .glightbox-container .gslide-description,
    .gslide-description {
        position: absolute !important;
        bottom: 20px !important;
        right: 20px !important;
        left: auto !important;
        top: auto !important;
        background: rgba(0, 0, 0, 0.75) !important;
        color: white !important;
        padding: 6px 12px !important;
        border-radius: 4px !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        z-index: 1000 !important;
        width: auto !important;
        max-width: none !important;
        margin: 0 !important;
        transform: none !important;
    }
    .glightbox-container .gslide-title {
        display: none !important;
    }
    .gslide-description p {
        margin: 0 !important;
    }
    /* Floating/sticky navigation bar */
    .poses-navigation {
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 0.75rem 1rem;
        background: var(--theme);
        border-bottom: 1px solid var(--border);
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        margin: 0 calc(-1 * var(--gap));
    }
    .poses-nav-links {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        list-style: none;
    }
    .poses-nav-btn {
        padding: 0.4rem 1.25rem;
        background: var(--entry);
        border: 1px solid var(--border);
        border-radius: 4px;
        text-decoration: none;
        color: var(--primary);
        font-weight: 500;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        font-family: inherit;
    }
    .poses-nav-btn:hover {
        background: var(--tertiary);
    }
    .poses-nav-btn.active {
        background: var(--primary);
        color: var(--theme);
        border-color: var(--primary);
    }
    /* Sections */
    .poses-section {
        margin-bottom: 2rem;
    }
    .poses-section.poses-hidden {
        display: none;
    }
    .poses-section-heading {
        font-size: 24px;
        margin: 24px 0 16px;
        font-weight: 600;
    }
    .poses-back-to-top {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: none;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transform: translateY(8px);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        z-index: 999;
    }
    .poses-back-to-top.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .poses-back-to-top:focus {
        outline: 2px solid rgba(0, 0, 0, 0.35);
        outline-offset: 2px;
    }
    @media (max-width: 480px) {
        .poses-back-to-top {
            right: 12px;
            bottom: 12px;
            width: 40px;
            height: 40px;
        }
        .poses-nav-btn {
            padding: 0.4rem 0.9rem;
            font-size: 14px;
        }
    }
</style>

<header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
</header>

<nav class="poses-navigation" aria-label="Pose category filter">
    <ul class="poses-nav-links" role="list">
        <li><button class="poses-nav-btn active" data-filter="all" aria-pressed="true">All</button></li>
        <li><button class="poses-nav-btn" data-filter="solo" aria-pressed="false">Solo</button></li>
        <li><button class="poses-nav-btn" data-filter="duo" aria-pressed="false">Duo</button></li>
        <li><button class="poses-nav-btn" data-filter="triple" aria-pressed="false">Triple</button></li>
        <li><button class="poses-nav-btn" data-filter="groups" aria-pressed="false">Groups</button></li>
    </ul>
</nav>

<div class="poses-container">
        {{- $poseCategories := slice "solo" "duo" "triple" "groups" }}
        
        {{- range $poseCategories }}
        {{- $category := . }}
        {{- $section := $.Site.GetPage (printf "/poses/%s" $category) }}
        {{- $categoryTitle := "Gallery" }}
        {{- if $section }}
            {{- $categoryTitle = $section.Title }}
        {{- end }}
        
        {{- /* Get images from the section's resources */ -}}
        {{- $images := slice }}
        {{- $imageMap := dict }}
        {{- if $section }}
            {{- range $section.Resources.Match "*.{jpg,jpeg,png,webp,gif}" }}
                {{- $baseName := path.BaseName .Name }}
                {{- /* Only process files with purely numeric names */ -}}
                {{- if gt (len (findRE "^[0-9]+$" $baseName)) 0 }}
                    {{- $numericName := int $baseName }}
                    {{- $imageMap = merge $imageMap (dict (string $numericName) .) }}
                {{- end }}
            {{- end }}
            {{- /* Sort by numeric key and rebuild slice */ -}}
            {{- $sortedKeys := slice }}
            {{- range $key, $val := $imageMap }}
                {{- $sortedKeys = $sortedKeys | append (int $key) }}
            {{- end }}
            {{- $sortedKeys = sort $sortedKeys }}
            {{- range $sortedKeys }}
                {{- $images = $images | append (index $imageMap (string .)) }}
            {{- end }}
        {{- end }}
        
        <section class="poses-section" id="{{ $category }}" data-category="{{ $category }}">
            <h2 class="poses-section-heading">{{ $categoryTitle }}</h2>
            {{- if gt (len $images) 0 }}
                <div class="poses-grid" id="poses-grid-{{ $category }}">
                    {{- range $images }}
                    {{- $small := .Fit "300x2000 webp q85" }}
                    {{- $medium := .Fit "600x2000 webp q85" }}
                    {{- $large := .Fit "1200x2000 webp q85" }}
                    {{- $imageName := path.BaseName .Name }}
                    <a href="{{ $large.RelPermalink }}" class="poses-image-link" data-lg-size="{{ $large.Width }}-{{ $large.Height }}" data-description="{{ $imageName }}">
                        <img 
                            src="{{ $small.RelPermalink }}" 
                            srcset="{{ $small.RelPermalink }} 300w, {{ $medium.RelPermalink }} 600w, {{ $large.RelPermalink }} 1200w"
                            sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                            alt="Pose {{ $imageName }} in {{ $categoryTitle }} category"
                            class="poses-grid-image"
                            loading="lazy"
                        >
                        <span class="poses-image-number">{{ $imageName }}</span>
                    </a>
                    {{- end }}
                </div>
            {{- else }}
                <p class="poses-empty-gallery">No images yet. Add images to <code>content/content/poses/{{ $category }}/</code></p>
            {{- end }}
        </section>
        {{- end }}
</div>

<button type="button" class="poses-back-to-top" aria-label="Back to top">
    â–²
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" integrity="sha384-TOxsBplaL96/QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.1/js/glightbox.min.js" integrity="sha384-MZZbZ6RXJudK43v1qY1zOWKOU2yfeBPatuFoKyHAaAgHTUZhwblRTc9CphTt4IGQ" crossorigin="anonymous"></script>
<script>
    (function() {
        'use strict';

        var lightbox = null;

        function initGallery(selector) {
            // Initialize justified gallery for visible grids
            if (window.jQuery && jQuery.fn.justifiedGallery) {
                var target = selector ? jQuery(selector) : jQuery('.poses-grid');
                try { target.justifiedGallery('destroy'); } catch(e) {}
                target.justifiedGallery({
                    rowHeight: 220,
                    margins: 16,
                    lastRow: 'nojustify',
                    captions: false,
                    imagesSelector: 'img'
                });
            }

            // Reinitialize GLightbox for currently visible images
            if (!window.GLightbox) return;
            if (lightbox) {
                lightbox.destroy();
            }
            lightbox = GLightbox({
                selector: '.poses-section:not(.poses-hidden) .poses-grid a',
                touchNavigation: true,
                loop: true,
                slideEffect: 'slide'
            });

            // Style description as badge on image
            function styleDescription() {
                var allSlides = document.querySelectorAll('.gslide');
                Array.prototype.forEach.call(allSlides, function(slide) {
                    var desc = slide.querySelector('.gslide-description');
                    var media = slide.querySelector('.gslide-media');
                    if (desc && media && desc.parentElement !== media) {
                        media.appendChild(desc);
                    }
                });
            }

            lightbox.on('open', function() { setTimeout(styleDescription, 150); });
            lightbox.on('slide_changed', function() { setTimeout(styleDescription, 50); });
        }

        function setFilter(filter) {
            var sections = document.querySelectorAll('.poses-section');
            Array.prototype.forEach.call(sections, function(section) {
                var category = section.getAttribute('data-category');
                if (filter === 'all' || filter === category) {
                    section.classList.remove('poses-hidden');
                } else {
                    section.classList.add('poses-hidden');
                }
            });

            // Update active button state
            var buttons = document.querySelectorAll('.poses-nav-btn');
            Array.prototype.forEach.call(buttons, function(btn) {
                var isActive = btn.getAttribute('data-filter') === filter;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });

            // Reinitialize gallery for newly visible sections
            if (filter === 'all') {
                initGallery(null);
            } else {
                initGallery('#poses-grid-' + filter);
            }
        }

        function initFilter() {
            var buttons = document.querySelectorAll('.poses-nav-btn');
            Array.prototype.forEach.call(buttons, function(btn) {
                btn.addEventListener('click', function() {
                    var filter = this.getAttribute('data-filter');
                    setFilter(filter);
                });
            });
        }

        function initBackToTop() {
            var backToTop = document.querySelector('.poses-back-to-top');
            if (!backToTop) return;

            function toggleVisibility() {
                var scrollTop = window.scrollY !== undefined ? window.scrollY : window.pageYOffset;
                if (scrollTop > 200) {
                    backToTop.classList.add('is-visible');
                } else {
                    backToTop.classList.remove('is-visible');
                }
            }

            backToTop.addEventListener('click', function() {
                try {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (err) {
                    window.scrollTo(0, 0);
                }
            });

            toggleVisibility();
            window.addEventListener('scroll', toggleVisibility, { passive: true });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initGallery(null);
                initFilter();
                initBackToTop();
            });
        } else {
            initGallery(null);
            initFilter();
            initBackToTop();
        }
    })();
</script>
{{- end }}
